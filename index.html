<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Steper Stock â€” Single File</title>
  <meta name="description" content="í•œ íŒŒì¼ë¡œ ëë‚˜ëŠ” ì£¼ì‹ ë¦¬ì„œì¹˜ ì €ì¥ì†Œ (ì˜¤í”„ë¼ì¸ ê°€ëŠ¥, ë¡œì»¬ íŒŒì¼ì—ì„œë„ ë™ì‘)">
  <style>/* inline minimal styles (same as bundle) */
:root{--bg:#0b0e14;--card:#121722;--muted:#94a3b8;--text:#e2e8f0;--accent:#60a5fa;--border:#233047}
:root[data-theme="light"]{--bg:#f7fafc;--card:#fff;--muted:#475569;--text:#0f172a;--border:#e2e8f0}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif}
a{color:var(--accent);text-decoration:none}
.app-header,.app-footer{border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(13,18,28,.9),rgba(11,14,20,.9));padding:14px 20px;position:sticky;top:0;z-index:10}
:root[data-theme="light"] .app-header,:root[data-theme="light"] .app-footer{background:linear-gradient(180deg,#fff,#f8fafc)}
.app-footer{border-top:1px solid var(--border);border-bottom:none;text-align:center}
.logo{width:28px;height:28px}
.app-title{margin:0 0 0 6px;font-size:20px}
.top-nav{display:flex;gap:10px;flex-wrap:wrap}
.top-nav a{background:#0f1520;color:var(--text);border:1px solid var(--border);padding:8px 12px;border-radius:10px}
:root[data-theme="light"] .top-nav a{background:#f1f5f9}
.top-nav a.active{border-color:var(--accent);color:var(--accent)}
main{max-width:1100px;margin:24px auto;padding:0 16px}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
.row{display:flex}.wrap{flex-wrap:wrap}.gap-s{gap:8px}.justify-between{justify-content:space-between}.align-center{align-items:center}.mt-s{margin-top:12px}
.grid{display:grid;gap:16px}.grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}@media(max-width:900px){.grid-2{grid-template-columns:1fr}}
input,textarea,select,button{background:#0f1520;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px}
:root[data-theme="light"] input,:root[data-theme="light"] textarea,:root[data-theme="light"] select,:root[data-theme="light"] button{background:#fff}
button{cursor:pointer}button.primary{background:var(--accent);color:#0b0e14;border-color:transparent;font-weight:600}
button.ghost{background:transparent;border:1px solid var(--border)}
.table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
table{border-collapse:separate;border-spacing:0;width:100%}th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
th{position:sticky;top:0;background:#0f1520;text-align:left}:root[data-theme="light"] th{background:#f8fafc}
.badge{display:inline-block;padding:2px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--accent);margin-right:4px}
.muted{color:var(--muted)}.note-cards{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;padding:0;list-style:none}
@media(max-width:900px){.note-cards{grid-template-columns:1fr}}.note-cards li{border:1px solid var(--border);border-radius:12px;padding:12px;background:#0f1520}
:root[data-theme="light"] .note-cards li{background:#fff}
@media print{body{background:#fff;color:#000}.app-header,.app-footer{display:none}main{max-width:800px}.card{box-shadow:none;border-color:#bbb}a{color:#000;text-decoration:underline}}</style>
</head>
<body>
  <header class="app-header">
    <div class="row justify-between align-center wrap">
      <div class="row align-center gap-s">
        <span class="logo">ğŸ“š</span>
        <h1 id="brandTitle" class="app-title">Steper Stock</h1>
      </div>
      <nav class="top-nav" aria-label="ì£¼ìš” ì„¹ì…˜">
        <a href="#/" data-route="/">í™ˆ</a>
        <a href="#/watchlist" data-route="/watchlist">ì›Œì¹˜ë¦¬ìŠ¤íŠ¸</a>
        <a href="#/notes" data-route="/notes">ë…¸íŠ¸</a>
        <a href="#/links" data-route="/links">ë§í¬</a>
        <a href="#/settings" data-route="/settings">ì„¤ì •</a>
      </nav>
      <div class="row gap-s">
        <button id="langToggle" class="ghost" title="ì–¸ì–´ KR/EN">KR/EN</button>
        <button id="themeToggle" class="ghost" aria-label="í…Œë§ˆ ì „í™˜">ğŸŒ“</button>
      </div>
    </div>
  </header>

  <main id="app"></main>

  <footer class="app-footer">
    <span>Â© 2025 Steper Stock Â· Single File</span>
  </footer>

  <script>/* inline SPA with hash router + brand + i18n (no service worker) */
const STORAGE_KEY="steper_stock_v1_single";const SETTINGS_KEY="steper_brand_settings_v1_single";const $=s=>document.querySelector(s),$$=s=>Array.from(document.querySelectorAll(s));
function applyTheme(t){document.documentElement.setAttribute("data-theme",t);localStorage.setItem("theme",t)}
applyTheme(localStorage.getItem("theme")||"dark");
$("#themeToggle").addEventListener("click",()=>applyTheme((localStorage.getItem("theme")||"dark")==="dark"?"light":"dark"));

const dict={ko:{home_quick_add:"ë¹ ë¥¸ ì¶”ê°€",add_ticker:"í‹°ì»¤ ì¶”ê°€",add_note:"ë…¸íŠ¸ ì¶”ê°€",ticker_placeholder:"í‹°ì»¤ (ì˜ˆ: AAPL, NVDA)",company_name:"íšŒì‚¬ëª… (ì„ íƒ)",sector:"ì„¹í„° (ì„ íƒ)",tags:"íƒœê·¸ (ì‰¼í‘œêµ¬ë¶„)",target:"ëª©í‘œê°€ (ì„ íƒ)",thesis:"ê°„ë‹¨ íˆ¬ì ì•„ì´ë””ì–´ (ì„ íƒ)",add:"ì¶”ê°€",recent_notes:"ìµœê·¼ ë…¸íŠ¸",search:"ê²€ìƒ‰",watchlist:"ì›Œì¹˜ë¦¬ìŠ¤íŠ¸",filter:"í‹°ì»¤/íƒœê·¸/ì„¹í„° í•„í„°",export_csv:"CSV ë‚´ë³´ë‚´ê¸°",import_csv:"CSV ì—…ë¡œë“œ (ì›Œì¹˜ë¦¬ìŠ¤íŠ¸ ì¼ê´„ ì¶”ê°€)",note_title:"ì œëª©",note_symbol:"ê´€ë ¨ í‹°ì»¤ (ì„ íƒ)",note_content:"í•µì‹¬ ìš”ì•½ / í•™ìŠµ ë‚´ìš© / ë¦¬ìŠ¤í¬ ë“±",links:"ìë£Œ ë§í¬",settings:"ì„¤ì •",brand_title:"ë¸Œëœë“œ/í…Œë§ˆ ì„¤ì •",brand_name:"ë¸Œëœë“œ ì´ë¦„",accent_color:"ê°•ì¡° ìƒ‰ìƒ(hex)",save:"ì €ì¥",ticker_detail:"í‹°ì»¤ ìƒì„¸",print_report:"ë¦¬í¬íŠ¸ ì¸ì‡„",open_chart:"ì°¨íŠ¸",notes:"ë…¸íŠ¸",delete:"ì‚­ì œ",edit:"í¸ì§‘"},
en:{home_quick_add:"Quick Add",add_ticker:"Add Ticker",add_note:"Add Note",ticker_placeholder:"Ticker (e.g., AAPL, NVDA)",company_name:"Company (optional)",sector:"Sector (optional)",tags:"Tags (comma-separated)",target:"Target (optional)",thesis:"Idea (optional)",add:"Add",recent_notes:"Recent Notes",search:"Search",watchlist:"Watchlist",filter:"Filter by ticker/tags/sector",export_csv:"Export CSV",import_csv:"Upload CSV (bulk add)",note_title:"Title",note_symbol:"Related ticker (optional)",note_content:"Summary / insights / risks",links:"Links",settings:"Settings",brand_title:"Brand & Theme",brand_name:"Brand name",accent_color:"Accent color (hex)",save:"Save",ticker_detail:"Ticker Detail",print_report:"Print Report",open_chart:"Chart",notes:"Notes",delete:"Delete",edit:"Edit"}};
let lang=localStorage.getItem("lang")||"ko";function t(k){return (dict[lang]&&dict[lang][k])||k}
$("#langToggle").addEventListener("click",()=>{lang=lang==="ko"?"en":"ko";localStorage.setItem("lang",lang);router()});

function loadSettings(){try{return Object.assign({brandName:"Steper Stock",accent:"#60a5fa"}, JSON.parse(localStorage.getItem(SETTINGS_KEY)||"{}"))}catch(_){return {brandName:"Steper Stock",accent:"#60a5fa"}}}
function saveSettings(s){localStorage.setItem(SETTINGS_KEY, JSON.stringify(s))}
function applyBrand(s){$("#brandTitle").textContent=s.brandName;document.documentElement.style.setProperty("--accent", s.accent)}
applyBrand(loadSettings());

function loadState(){try{return JSON.parse(localStorage.getItem(STORAGE_KEY))||{tickers:[],notes:[],links:[],createdAt:Date.now()}}catch(_){return {tickers:[],notes:[],links:[],createdAt:Date.now()}}}
function saveState(st){localStorage.setItem(STORAGE_KEY, JSON.stringify(st))}
let state=loadState();

const routes={"/":renderHome,"/watchlist":renderWatchlist,"/notes":renderNotes,"/links":renderLinks,"/settings":renderSettings,"/ticker/:symbol":renderTickerDetail};
function parseRoute(hash){const p=(hash.replace(/^#/,"")||"/").split("/").filter(Boolean);return (p[0]==="ticker"&&p[1])?{route:"/ticker/:symbol",params:{symbol:decodeURIComponent(p[1]).toUpperCase()}}:{route: (hash.replace(/^#/,"")||"/") in routes ? (hash.replace(/^#/,"")||"/") : "/", params:{}}}
function router(){const {route,params}=parseRoute(location.hash);$$(".top-nav a").forEach(a=>a.classList.toggle("active", a.getAttribute("href")==="#"+route));$("#app").innerHTML=routes[route](params);postRender(route,params)}
window.addEventListener("hashchange",router);window.addEventListener("load",router);

/* Views */
function renderHome(){return `
<section class="grid">
  <div class="card">
    <h2>${t("home_quick_add")}</h2>
    <div class="grid grid-2">
      <div>
        <h3>${t("add_ticker")}</h3>
        <form id="quickAddTicker" class="stack gap-s">
          <input required name="symbol" placeholder="${t("ticker_placeholder")}" autocomplete="off">
          <input name="name" placeholder="${t("company_name")}">
          <input name="sector" placeholder="${t("sector")}">
          <input name="tags" placeholder="${t("tags")}">
          <input name="target" type="number" step="0.01" placeholder="${t("target")}">
          <textarea name="thesis" rows="3" placeholder="${t("thesis")}"></textarea>
          <button type="submit" class="primary">${t("add")}</button>
        </form>
      </div>
      <div>
        <h3>${t("add_note")}</h3>
        <form id="quickAddNote" class="stack gap-s">
          <input required name="title" placeholder="${t("note_title")}">
          <input name="symbol" placeholder="${t("note_symbol")}">
          <input name="tags" placeholder="${t("tags")}">
          <textarea required name="content" rows="5" placeholder="${t("note_content")}"></textarea>
          <button type="submit" class="primary">${t("add")}</button>
        </form>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>${t("recent_notes")}</h2>
    <ul id="recentNotes" class="list"></ul>
  </div>
  <div class="card">
    <h2>${t("search")} <span class="muted">( / )</span></h2>
    <input id="globalSearch" placeholder="í‹°ì»¤/íšŒì‚¬/íƒœê·¸/ë…¸íŠ¸ ë‚´ìš© ê²€ìƒ‰â€¦">
    <ul id="searchResults" class="list"></ul>
  </div>
</section>`}
function renderWatchlist(){return `
<section class="card">
  <div class="row justify-between align-center">
    <h2>${t("watchlist")}</h2>
    <div class="row gap-s wrap">
      <input id="watchlistFilter" placeholder="${t("filter")}">
      <button id="exportCSV">${t("export_csv")}</button>
      <label class="ghost"><input type="file" id="csvUpload" accept=".csv,text/csv" hidden> ${t("import_csv")}</label>
    </div>
  </div>
  <div class="table-wrap">
    <table id="watchlistTable">
      <thead>
        <tr>
          <th data-sort="symbol">í‹°ì»¤</th>
          <th data-sort="name">íšŒì‚¬ëª…</th>
          <th data-sort="sector">ì„¹í„°</th>
          <th>íƒœê·¸</th>
          <th data-sort="target" class="num">ëª©í‘œê°€</th>
          <th>ì•„ì´ë””ì–´</th>
          <th>ë©”ëª¨</th>
          <th>ì‘ì—…</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="row justify-between align-center mt-s">
    <div class="muted" id="watchlistMeta"></div>
    <div class="pagination">
      <button id="prevPage" class="ghost">ì´ì „</button>
      <span id="pageInfo" class="muted"></span>
      <button id="nextPage" class="ghost">ë‹¤ìŒ</button>
    </div>
  </div>
</section>`}
function renderNotes(){return `
<section class="card">
  <div class="row justify-between align-center">
    <h2>${t("notes")}</h2>
    <input id="noteFilter" placeholder="ì œëª©/ë³¸ë¬¸/íƒœê·¸/í‹°ì»¤ ê²€ìƒ‰">
  </div>
  <ul id="notesList" class="note-cards"></ul>
</section>`}
function renderLinks(){return `
<section class="card">
  <h2>${t("links")}</h2>
  <form id="addLink" class="row gap-s wrap">
    <input required name="title" placeholder="ì œëª©">
    <input required name="url" placeholder="URL (https://â€¦)">
    <input name="desc" placeholder="ì„¤ëª… (ì„ íƒ)">
    <input name="tags" placeholder="${t("tags")}">
    <button type="submit">${t("add")}</button>
  </form>
  <ul id="linksList" class="list mt-s"></ul>
</section>`}
function renderSettings(){const s=loadSettings();return `
<section class="card">
  <h2>${t("brand_title")}</h2>
  <form id="brandForm" class="grid grid-2">
    <label>${t("brand_name")} <input name="brandName" value="${escapeAttr(s.brandName)}"></label>
    <label>${t("accent_color")} <input name="accent" value="${escapeAttr(s.accent)}" placeholder="#60a5fa"></label>
    <div class="row gap-s"><button type="submit" class="primary">${t("save")}</button></div>
  </form>
</section>`}
function renderTickerDetail({symbol}){const tk=state.tickers.find(x=>x.symbol===symbol)||{symbol};const notes=state.notes.filter(n=>n.symbol===symbol);const tags=(tk.tags||[]).map(x=>`<span class="badge">#${escapeHtml(x)}</span>`).join(" ");return `
<section class="card">
  <div class="row justify-between align-center">
    <h2>${t("ticker_detail")}: <strong>${escapeHtml(symbol)}</strong></h2>
    <div class="row gap-s">
      <button data-chart="${symbol}">${t("open_chart")}</button>
      <button onclick="window.print()">${t("print_report")}</button>
    </div>
  </div>
  <div class="grid grid-2">
    <div>
      <p><strong>íšŒì‚¬ëª…:</strong> ${escapeHtml(tk.name||"-")}</p>
      <p><strong>ì„¹í„°:</strong> ${escapeHtml(tk.sector||"-")} ${tags}</p>
      <p><strong>ëª©í‘œê°€:</strong> ${tk.target ?? "-"}</p>
      <p><strong>ì•„ì´ë””ì–´:</strong><br>${escapeHtml(tk.thesis||"-")}</p>
      <p><strong>ë©”ëª¨:</strong><br>${escapeHtml(tk.notes||"-")}</p>
    </div>
    <div>
      <div id="tvInline" style="width:100%;height:360px;border:1px solid var(--border);border-radius:12px;overflow:hidden"></div>
      <p class="muted">â€» ìƒë‹¨ ë²„íŠ¼ì˜ ëª¨ë‹¬ ì°¨íŠ¸ë¡œ í™•ëŒ€ ê°€ëŠ¥</p>
    </div>
  </div>
  <hr class="divider">
  <h3>ê´€ë ¨ ë…¸íŠ¸</h3>
  <ul class="list">
    ${notes.map(n=>`<li><strong>${escapeHtml(n.title)}</strong> Â· <span class="muted">${humanDate(n.updatedAt)}</span><br>${escapeHtml(n.content)}</li>`).join("") || "<li class='muted'>ì—°ê²°ëœ ë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</li>"}
  </ul>
</section>`}

/* Post-render */
let sortKey="symbol",sortAsc=true,page=1,pageSize=10;
function postRender(route,params){
  $$(".top-nav a").forEach(a=>a.classList.toggle("active", a.getAttribute("href")==="#"+route));
  if(route==="/"){bindHome();renderRecentNotes();globalSearch()}
  else if(route==="/watchlist"){renderWatchlistTable();bindWatchlist()}
  else if(route==="/notes"){bindNotes();renderNotesList()}
  else if(route==="/links"){bindLinks();renderLinksList()}
  else if(route==="/settings"){bindSettings()}
  else if(route==="/ticker/:symbol"){ensureTV(()=>{new TradingView.widget({symbol:params.symbol,autosize:true,interval:"60",timezone:"Asia/Seoul",theme:(localStorage.getItem("theme")||"dark")==="dark"?"dark":"light",style:"1",locale:"kr",allow_symbol_change:true,container_id:"tvInline"})});document.addEventListener("click",onGlobalClick)}
}

/* Home */
function bindHome(){
  $("#quickAddTicker").addEventListener("submit",(e)=>{e.preventDefault();const fd=new FormData(e.target);
    const tk={id:crypto.randomUUID(),symbol:fd.get("symbol").trim().toUpperCase(),name:fd.get("name").trim(),sector:fd.get("sector").trim(),tags:fd.get("tags").split(",").map(s=>s.trim()).filter(Boolean),target:fd.get("target")?Number(fd.get("target")):null,thesis:fd.get("thesis").trim(),notes:"",createdAt:Date.now(),updatedAt:Date.now()};
    if(!tk.symbol){alert("í‹°ì»¤ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.");return}
    state.tickers.unshift(tk);saveState(state);location.hash="#/ticker/"+encodeURIComponent(tk.symbol);
  });
  $("#quickAddNote").addEventListener("submit",(e)=>{e.preventDefault();const fd=new FormData(e.target);
    const note={id:crypto.randomUUID(),title:fd.get("title").trim(),symbol:(fd.get("symbol")||"").trim().toUpperCase(),tags:fd.get("tags").split(",").map(s=>s.trim()).filter(Boolean),content:fd.get("content").trim(),createdAt:Date.now(),updatedAt:Date.now()};
    if(!note.title||!note.content){alert("ì œëª©ê³¼ ë³¸ë¬¸ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.");return}
    state.notes.unshift(note);saveState(state);renderRecentNotes();alert("ë…¸íŠ¸ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
  });
  document.addEventListener("keydown",(e)=>{if(e.key==="/"){e.preventDefault();$("#globalSearch").focus()}});
}
function renderRecentNotes(){const ul=$("#recentNotes");if(!ul) return; ul.innerHTML="";state.notes.slice(0,8).forEach(n=>{const li=document.createElement("li");li.innerHTML=`<strong>${escapeHtml(n.title)}</strong> <span class="muted">Â· ${humanDate(n.updatedAt)} ${n.symbol?"Â· "+escapeHtml(n.symbol):""}</span><br>${escapeHtml(n.content).slice(0,160)}${n.content.length>160?"â€¦":""}`;ul.appendChild(li)})}
function globalSearch(){const input=$("#globalSearch");if(!input) return; input.addEventListener("input",(e)=>{const q=e.target.value.trim().toLowerCase();const list=$("#searchResults");list.innerHTML="";if(!q) return;
  const inTickers=state.tickers.filter(t=>(t.symbol+t.name+t.sector+t.tags.join(",")+t.thesis+(t.notes||"")).toLowerCase().includes(q));
  const inNotes=state.notes.filter(n=>(n.title+n.content+n.symbol+n.tags.join(",")).toLowerCase().includes(q));
  const inLinks=state.links.filter(l=>(l.title+l.url+(l.desc||"")+l.tags.join(",")).toLowerCase().includes(q));
  [...inTickers.map(t=>({type:"í‹°ì»¤",label:`${t.symbol} ${t.name||""}`,extra:t.sector,id:t.id,link:`#/ticker/${t.symbol}`})),
   ...inNotes.map(n=>({type:"ë…¸íŠ¸",label:n.title,extra:n.symbol,id:n.id})),
   ...inLinks.map(l=>({type:"ë§í¬",label:l.title,extra:l.url,id:l.id}))].slice(0,20).forEach(r=>{const li=document.createElement("li");li.innerHTML=`<span class="badge">${r.type}</span> <a href="${r.link||'#'}"><strong>${escapeHtml(r.label)}</strong></a> <span class="muted">${escapeHtml(r.extra||"")}</span>`;list.appendChild(li)});
});}

/* Watchlist */
function getSortedFilteredTickers(){const q=($("#watchlistFilter")?.value||"").toLowerCase();return state.tickers.filter(t=>(t.symbol+t.name+t.sector+t.tags.join(",")).toLowerCase().includes(q)).sort((a,b)=>{let va=a[sortKey],vb=b[sortKey];if(sortKey==="target"){va=va??-Infinity;vb=vb??-Infinity;return sortAsc?(va-vb):(vb-va)} va=(va||"").toString().toLowerCase();vb=(vb||"").toString().toLowerCase(); if(va<vb) return sortAsc?-1:1; if(va>vb) return sortAsc?1:-1; return 0;})}
function renderWatchlistTable(){const tbody=$("#watchlistTable tbody");const rows=getSortedFilteredTickers();const total=rows.length;const totalPages=Math.max(1,Math.ceil(total/pageSize));if(page>totalPages) page=totalPages;const start=(page-1)*pageSize;const slice=rows.slice(start,start+pageSize);tbody.innerHTML="";slice.forEach(t=>{const tr=document.createElement("tr");tr.innerHTML=`
  <td><a href="#/ticker/${t.symbol}"><strong>${escapeHtml(t.symbol)}</strong></a></td>
  <td>${escapeHtml(t.name||"")}</td>
  <td>${escapeHtml(t.sector||"")}</td>
  <td>${(t.tags||[]).map(tag=>`<span class="badge">#${escapeHtml(tag)}</span>`).join(" ")}</td>
  <td class="num">${t.target ?? ""}</td>
  <td>${escapeHtml(t.thesis||"")}</td>
  <td contenteditable data-id="${t.id}" data-field="notes">${escapeHtml(t.notes||"")}</td>
  <td class="actions"><button data-edit="${t.id}">${t("edit")}</button><button data-chart="${t.symbol}">${t("open_chart")}</button><button data-delete="${t.id}">${t("delete")}</button></td>`;tbody.appendChild(tr)});
  $("#watchlistMeta").textContent=`${total}ê°œ Â· ${page}/${totalPages} í˜ì´ì§€ Â· ì •ë ¬: ${sortKey} ${sortAsc?"â†‘":"â†“"}`; $("#pageInfo").textContent=`${page} / ${totalPages}`;
}
function bindWatchlist(){ $("#watchlistFilter").addEventListener("input",()=>{page=1;renderWatchlistTable()});
  $("#prevPage").addEventListener("click",()=>{page=Math.max(1,page-1);renderWatchlistTable()});
  $("#nextPage").addEventListener("click",()=>{const totalPages=Math.max(1,Math.ceil(getSortedFilteredTickers().length/pageSize));page=Math.min(totalPages,page+1);renderWatchlistTable()});
  $$("#watchlistTable th[data-sort]").forEach(th=>{th.addEventListener("click",()=>{const key=th.getAttribute("data-sort"); if(sortKey===key) sortAsc=!sortAsc; else {sortKey=key;sortAsc=true} renderWatchlistTable()})});
  $("#watchlistTable").addEventListener("click",(e)=>{const delId=e.target.getAttribute("data-delete");const editId=e.target.getAttribute("data-edit");const chartSym=e.target.getAttribute("data-chart");
    if(delId){ if(confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){ state.tickers=state.tickers.filter(t=>t.id!==delId); saveState(state); renderWatchlistTable(); } }
    else if(editId){ const t=state.tickers.find(x=>x.id===editId); if(!t) return;
      const name=prompt("íšŒì‚¬ëª…",t.name||"")??t.name; const sector=prompt("ì„¹í„°",t.sector||"")??t.sector; const tags=prompt("íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„)",(t.tags||[]).join(","))??(t.tags||[]).join(","); const target=prompt("ëª©í‘œê°€",t.target??"")??(t.target??""); const thesis=prompt("ì•„ì´ë””ì–´",t.thesis||"")??t.thesis;
      Object.assign(t,{name:name?.trim(),sector:sector?.trim(),tags:(tags||"").split(",").map(s=>s.trim()).filter(Boolean),target:target!==""?Number(target):null,thesis:thesis?.trim(),updatedAt:Date.now()}); saveState(state); renderWatchlistTable();
    } else if(chartSym){ openChartModal(chartSym); }
  });
  $("#watchlistTable").addEventListener("input",(e)=>{const cell=e.target.closest("[contenteditable]"); if(!cell) return; const id=cell.dataset.id, field=cell.dataset.field; const t=state.tickers.find(x=>x.id===id); if(!t) return; t[field]=cell.innerText.trim(); t.updatedAt=Date.now(); saveState(state); });
  $("#exportCSV").addEventListener("click",()=>{const headers=["symbol","name","sector","tags","target","thesis","notes"]; const rows=state.tickers.map(t=>[t.symbol,t.name||"",t.sector||"", (t.tags||[]).join(";"), t.target??"", (t.thesis||"").replace(/\n/g," "), (t.notes||"").replace(/\n/g," ")]); const csv=[headers.join(","), ...rows.map(r=>r.map(s=>String(s).includes(",")?`"${String(s).replace(/"/g,'""')}"`:s).join(","))].join("\n"); downloadBlob(new Blob([csv],{type:"text/csv"}),"watchlist.csv") });
  $("#csvUpload").addEventListener("change",(e)=>{const file=e.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=()=>{const text=reader.result; const lines=text.split(/\\r?\\n/).filter(Boolean); const header=lines.shift().split(","); const idx=name=>header.findIndex(h=>h.trim().toLowerCase()===name); const res=[]; for(const line of lines){ const cols=parseCSVLine(line); res.push({id:crypto.randomUUID(),symbol:(cols[idx("symbol")]||"").trim().toUpperCase(),name:(cols[idx("name")]||"").trim(),sector:(cols[idx("sector")]||"").trim(),tags:(cols[idx("tags")]||"").split(/[;,]/).map(s=>s.trim()).filter(Boolean),target:(cols[idx("target")]||"")===""?null:Number(cols[idx("target")]),thesis:(cols[idx("thesis")]||"").trim(),notes:(cols[idx("notes")]||"").trim(),createdAt:Date.now(),updatedAt:Date.now()})}
    for(const t of res){ if(!t.symbol) continue; const ex=state.tickers.find(x=>x.symbol===t.symbol); if(ex){ Object.assign(ex,t,{id:ex.id,createdAt:ex.createdAt,updatedAt:Date.now()}) } else { state.tickers.push(t) } } saveState(state); renderWatchlistTable(); alert(`CSVì—ì„œ ${res.length}ê°œ í•­ëª©ì„ ì²˜ë¦¬í–ˆìŠµë‹ˆë‹¤.`)}; reader.readAsText(file) });
}

/* Notes & Links */
function bindNotes(){ $("#noteFilter").addEventListener("input", renderNotesList); document.addEventListener("click", onGlobalClick) }
function renderNotesList(){const q=($("#noteFilter")?.value||"").toLowerCase(); const ul=$("#notesList"); if(!ul) return; ul.innerHTML=""; state.notes.filter(n=>(n.title+n.content+n.symbol+n.tags.join(",")).toLowerCase().includes(q)).forEach(n=>{const li=document.createElement("li"); li.innerHTML=`<div class="row justify-between"><div><strong>${escapeHtml(n.title)}</strong> ${n.symbol?`<a href="#/ticker/${n.symbol}" class="badge">${escapeHtml(n.symbol)}</a>`:""}</div><div class="muted">${humanDate(n.updatedAt)} Â· ${(n.tags||[]).map(t=>"#"+escapeHtml(t)).join(" ")}</div></div><div class="mt-s">${escapeHtml(n.content).replace(/\\n/g,"<br>")}</div><div class="actions mt-s"><button data-note-edit="${n.id}">${t("edit")}</button><button data-note-delete="${n.id}">${t("delete")}</button></div>`; ul.appendChild(li) })}
function bindLinks(){ $("#addLink").addEventListener("submit",(e)=>{e.preventDefault(); const fd=new FormData(e.target); const link={id:crypto.randomUUID(),title:fd.get("title").trim(),url:fd.get("url").trim(),desc:(fd.get("desc")||"").trim(),tags:(fd.get("tags")||"").split(",").map(s=>s.trim()).filter(Boolean),createdAt:Date.now(),updatedAt:Date.now()}; try{new URL(link.url)}catch(_){alert("URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return } state.links.unshift(link); saveState(state); e.target.reset(); renderLinksList(); }); document.addEventListener("click", onGlobalClick) }
function renderLinksList(){const ul=$("#linksList"); if(!ul) return; ul.innerHTML=""; state.links.forEach(l=>{const li=document.createElement("li"); li.innerHTML=`<a href="${escapeAttr(l.url)}" target="_blank" rel="noopener">${escapeHtml(l.title)}</a> ${(l.tags||[]).length? `<span class="muted"> Â· ${(l.tags||[]).map(t=>"#"+escapeHtml(t)).join(" ")}</span>`:""} <div class="muted">${escapeHtml(l.desc||"")}</div><div class="actions mt-s"><button data-link-edit="${l.id}">${t("edit")}</button><button data-link-delete="${l.id}">${t("delete")}</button></div>`; ul.appendChild(li) })}
function bindSettings(){const form=$("#brandForm"); form.addEventListener("submit",(e)=>{e.preventDefault(); const fd=new FormData(form); const s={brandName:fd.get("brandName").trim()||"Steper Stock",accent:fd.get("accent").trim()||"#60a5fa"}; saveSettings(s); applyBrand(s); alert("ë¸Œëœë“œ ì„¤ì •ì„ ì €ì¥í–ˆìŠµë‹ˆë‹¤.") })}

/* Global actions */
function onGlobalClick(e){
  const delNote=e.target.getAttribute("data-note-delete"); const editNote=e.target.getAttribute("data-note-edit"); const delLink=e.target.getAttribute("data-link-delete"); const editLink=e.target.getAttribute("data-link-edit"); const chartSym=e.target.getAttribute("data-chart");
  if(delNote){ if(confirm("ë…¸íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?")){ state.notes=state.notes.filter(n=>n.id!==delNote); saveState(state); renderNotesList() } }
  else if(editNote){ const n=state.notes.find(x=>x.id===editNote); if(!n) return; const title=prompt("ì œëª©",n.title)??n.title; const symbol=prompt("ê´€ë ¨ í‹°ì»¤",n.symbol||"")??n.symbol; const tags=prompt("íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„)",(n.tags||[]).join(","))??(n.tags||[]).join(","); const content=prompt("ë‚´ìš©",n.content)??n.content; Object.assign(n,{title:title?.trim(),symbol:(symbol||"").trim().toUpperCase(),tags:(tags||"").split(",").map(s=>s.trim()).filter(Boolean),content:content?.trim(),updatedAt:Date.now()}); saveState(state); renderNotesList() }
  else if(delLink){ if(confirm("ë§í¬ë¥¼ ì‚­ì œí• ê¹Œìš”?")){ state.links=state.links.filter(l=>l.id!==delLink); saveState(state); renderLinksList() } }
  else if(editLink){ const l=state.links.find(x=>x.id===editLink); if(!l) return; const title=prompt("ì œëª©",l.title)??l.title; const url=prompt("URL",l.url)??l.url; const desc=prompt("ì„¤ëª…",l.desc||"")??l.desc; const tags=prompt("íƒœê·¸(ì‰¼í‘œ êµ¬ë¶„)",(l.tags||[]).join(","))??(l.tags||[]).join(","); try{new URL(url)}catch(_){alert("URL í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); return } Object.assign(l,{title:title?.trim(),url:url?.trim(),desc:desc?.trim(),tags:(tags||"").split(",").map(s=>s.trim()).filter(Boolean),updatedAt:Date.now()}); saveState(state); renderLinksList() }
  else if(chartSym){ openChartModal(chartSym) }
}

/* TradingView */
let tvLoaded=false; function ensureTV(cb){ if(tvLoaded) return cb(); const s=document.createElement("script"); s.src="https://s3.tradingview.com/tv.js"; s.onload=()=>{tvLoaded=true; cb()}; document.body.appendChild(s) }
function openChartModal(symbol){ ensureTV(()=>{ const overlay=document.createElement("div"); overlay.style.cssText="position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;z-index:1000"; const box=document.createElement("div"); box.style.cssText="width:min(96vw,1100px);height:min(80vh,720px);background:var(--card);border:1px solid var(--border);border-radius:16px;overflow:hidden;position:relative"; const close=document.createElement("button"); close.textContent="ë‹«ê¸°"; close.style.cssText="position:absolute;top:10px;right:10px"; close.onclick=()=>overlay.remove(); box.appendChild(close); const tvDiv=document.createElement("div"); tvDiv.id="tv_"+Date.now(); tvDiv.style.cssText="width:100%;height:100%"; box.appendChild(tvDiv); overlay.appendChild(box); document.body.appendChild(overlay); new TradingView.widget({symbol,autosize:true,interval:"60",timezone:"Asia/Seoul",theme:(localStorage.getItem("theme")||"dark")==="dark"?"dark":"light",style:"1",locale:"kr",allow_symbol_change:true,container_id:tvDiv.id}); })}

/* Utils */
function escapeHtml(s=""){return s.replace(/[&<>\"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]))}
function escapeAttr(s=""){return escapeHtml(s).replace(/"/g,"&quot;")}
function humanDate(ts){const d=new Date(ts);const p=n=>String(n).padStart(2,"0");return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}`}
function downloadBlob(blob,filename){const a=document.createElement("a");a.href=URL.createObjectURL(blob);a.download=filename;document.body.appendChild(a);a.click();setTimeout(()=>{URL.revokeObjectURL(a.href);a.remove()},0)}
function parseCSVLine(line){const out=[];let cur="",inQ=false;for(let i=0;i<line.length;i++){const ch=line[i];if(ch==='\"'){if(inQ && line[i+1]==='\"'){cur+='\"';i++}else inQ=!inQ}else if(ch===','&&!inQ){out.push(cur);cur=""}else{cur+=ch}}out.push(cur);return out}
</script>
</body>
</html>
